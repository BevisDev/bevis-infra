[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

    # Buffer lưu trên disk khi output (Kafka) bị lỗi
    storage.path              /var/fluent-bit/buffer
    storage.sync              normal
    storage.checksum          Off
    storage.backlog.mem_limit 50M

# ============ INPUT: app logs ============
[INPUT]
    Name              tail
    Tag               app.log
    Path              /var/logs/app/*.log
    Path_Key          source
    Refresh_Interval  5
    Skip_Long_Lines   On
    DB                /var/fluent-bit/buffer/app-log.db

    # bật buffer file -> không mất log khi Kafka down
    storage.type      filesystem
    Mem_Buf_Limit     10M

# ============ INPUT: job logs ============
[INPUT]
    Name              tail
    Tag               job.log
    Path              /var/logs/job/*.log
    Path_Key          source
    Refresh_Interval  5
    Skip_Long_Lines   On
    DB                /var/fluent-bit/buffer/job-log.db

    storage.type      filesystem
    Mem_Buf_Limit     10M

# (optional) gắn thêm field nếu muốn
[FILTER]
    Name   modify
    Match  app.log
    Add    log_type   app

[FILTER]
    Name   modify
    Match  job.log
    Add    log_type   job

# ============ OUTPUT: Kafka cho app logs ============
[OUTPUT]
    Name          kafka
    Match         app.log
    Brokers       kafka:29092
    Topics        app1_topic

    # format JSON nhỏ gọn: { "log": "...", "source": "...", "log_type": "app" }
    Format        json
    Timestamp_Key @timestamp

    rdkafka.request.required.acks    -1
    rdkafka.log.connection.close     false
    Retry_Limit                      False   # retry mãi tới khi gửi được

# ============ OUTPUT: Kafka cho job logs ============
[OUTPUT]
    Name          kafka
    Match         job.log
    Brokers       kafka:29092
    Topics        app2_topic

    Format        json
    Timestamp_Key @timestamp

    rdkafka.request.required.acks    -1
    rdkafka.log.connection.close     false
    Retry_Limit                      False
